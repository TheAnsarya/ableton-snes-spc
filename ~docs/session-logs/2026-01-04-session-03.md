# Session Log - 2026-01-04 - Session 03

## Overview

Continuation of VST3 wrapper integration. Added pitch bend support, file loading system, GUI scaffolding with VSTGUI, and comprehensive documentation.

## Goals

1. ✅ Add pitch bend VST3 parameters and handling
2. ✅ Add aftertouch event handling
3. ✅ Create file loading message system
4. ✅ Create GUI scaffolding with VSTGUI
5. ✅ Document VST3 SDK setup and cross-platform builds
6. ✅ Update CMake for GUI support
7. ✅ Build verification (146 tests pass)

## Work Completed

### Pitch Bend Support

**spc_params.h** - Added pitch bend parameters:
- `kParamPitchBend0-7` (IDs 400-407) - Per-channel pitch bend
- `kParamPitchBendRange` (ID 500) - Global pitch bend range (1-24 semitones)

**spc_processor.cpp** - Parameter handling:
- Convert 0-1 normalized value to MIDI pitch bend (0-16383)
- Map pitch bend range 0-1 to 1-24 semitones

**spc_controller.cpp** - Register pitch bend parameters with center default (0.5)

### Aftertouch Support

Added `kPolyPressureEvent` handling → maps to modulation CC

### File Loading System

**spc_messages.h** (NEW) - Message protocol for processor-controller communication:
- `kMsgLoadSpcFile` - Load SPC from file path
- `kMsgLoadSpcData` - Load SPC from binary data
- `kMsgSpcLoaded` - Success notification
- `kMsgSpcError` - Error notification
- Attribute keys for file paths, data, errors

**spc_processor.cpp** - Added `notify()` override:
- Handles incoming file load messages
- Extracts file path or binary data
- Calls DotNetHost to load
- Sends success/error replies back to controller

**spc_controller.h/cpp** - Public file loading API:
- `loadSpcFile(path)` - UI calls this to load files
- `loadSpcData(data, length)` - UI calls this to load from memory
- `notify()` handles success/error responses
- `spcLoaded_` and `currentSpcPath_` state tracking

### GUI Scaffolding

**gui/spc_editor.h** (NEW) - VSTGUI-based editor:
- Inherits from `VST3Editor`
- Implements drag-and-drop for SPC files
- `onDrop()`, `onDragEnter()`, `onDragMove()`, `onDragLeave()`
- `containsSpcFile()` checks for .spc, .rsn, .spcx extensions
- `extractFilePath()` gets path from drag data

**gui/spc_editor.cpp** (NEW) - Editor implementation:
- File type validation
- Path extraction from drag package
- Controller integration for file loading

**resource/spc_editor.uidesc** (NEW) - VSTGUI UI description:
- Dark theme (Ableton-style aesthetic)
- Colors: bg (#282828), panel (#383838), accent (#4a9fff)
- Transport section: Play/Pause, Loop, Master Volume
- Drop zone for SPC files
- 8-channel mixer: Volume sliders, Mute buttons, Solo buttons
- 800x500 default size

### Documentation

**vst3/README.md** - Complete rewrite with:
- VST3 SDK installation guide
- Environment setup (Windows/macOS/Linux)
- Step-by-step build instructions
- Native AOT configuration
- Architecture diagrams
- Parameter reference tables
- MIDI support documentation
- Troubleshooting section

### CMake Updates

**CMakeLists.txt**:
- Added `SMTG_ENABLE_VSTGUI_SUPPORT` option
- Conditional GUI source compilation
- VSTGUI library linking
- Resource file bundling for UI description

## Files Created/Modified

| File | Status | Description |
|------|--------|-------------|
| `spc_params.h` | Modified | Added pitch bend param IDs (400-407, 500) |
| `spc_processor.cpp` | Modified | Pitch bend, aftertouch, notify() handler |
| `spc_processor.h` | Modified | Added notify() override |
| `spc_controller.cpp` | Modified | Pitch bend params, file loading, notify() |
| `spc_controller.h` | Modified | loadSpcFile/Data, state tracking |
| `spc_messages.h` | **NEW** | Message protocol definitions |
| `gui/spc_editor.h` | **NEW** | VSTGUI editor class |
| `gui/spc_editor.cpp` | **NEW** | Drag-and-drop implementation |
| `resource/spc_editor.uidesc` | **NEW** | UI layout (800x500, 8 channels) |
| `CMakeLists.txt` | Modified | VSTGUI support, GUI sources |
| `README.md` | Modified | Complete documentation rewrite |

## Technical Notes

### Message Flow for File Loading

```text
UI (drag file) → SpcController::loadSpcFile()
    → allocateMessage(kMsgLoadSpcFile)
    → sendMessage() to processor

Processor::notify() receives message
    → extracts file path from attributes
    → calls loadSpcFile() on DotNetHost
    → sends kMsgSpcLoaded or kMsgSpcError reply

Controller::notify() receives reply
    → updates spcLoaded_ state
    → (future: update UI indicators)
```

### Pitch Bend Value Conversion

```cpp
// VST3 parameter (0.0 - 1.0) to MIDI pitch bend (0 - 16383)
int pitchBendValue = static_cast<int>(value * 16383);
// Center at 8192 (value = 0.5)

// Pitch bend range (0.0 - 1.0) to semitones (1 - 24)
int semitones = 1 + static_cast<int>(value * 23);
```

### GUI Layout

```text
┌──────────────────────────────────────────────────────────┐
│ SNES SPC Player                                    [40px]│
├─────────────┬────────────────────────────────────────────┤
│ Transport   │        Drop SPC file here           [100px]│
│ [▶][⟳][Vol] │                                            │
├─────────────┴────────────────────────────────────────────┤
│ Channel Mixer                                     [330px]│
│ CH1  CH2  CH3  CH4  CH5  CH6  CH7  CH8                   │
│ [═]  [═]  [═]  [═]  [═]  [═]  [═]  [═]  Volume          │
│ [M]  [M]  [M]  [M]  [M]  [M]  [M]  [M]  Mute            │
│ [S]  [S]  [S]  [S]  [S]  [S]  [S]  [S]  Solo            │
└──────────────────────────────────────────────────────────┘
```

## Build Verification

- .NET build: ✅ Success
- .NET tests: ✅ 146/146 passing
- C++ VST3: ⚠️ Requires VST3 SDK (documented in README)

## Next Steps

1. Commit and push all changes
2. Test VST3 build with SDK installed
3. Wire controller to instantiate SpcEditor
4. Add waveform visualization
5. Add preset browser

## References

- [VSTGUI 4.x Reference](https://steinbergmedia.github.io/vst3_doc/vstgui/html/)
- [VST3 IMessage](https://steinbergmedia.github.io/vst3_doc/vstinterfaces/classSteinberg_1_1Vst_1_1IMessage.html)
- [VST3 Drag & Drop](https://steinbergmedia.github.io/vst3_doc/vstgui/html/md_page_creating_vst3_plugin_uidesc.html)
