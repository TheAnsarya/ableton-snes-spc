# SNES SPC VST3 Plugin - Session 04 Log

**Date:** 2026-01-05
**Focus:** GUI Integration - Sample Editor, View Switching, MIDI Learn, Visualization Pipeline

## Summary

Completed all remaining GUI integration tasks from previous session's "What's Next" list. Implemented sample editor controls, view mode switching, keyboard shortcuts, preset browser integration, MIDI learn functionality, and connected the real-time waveform visualization pipeline.

## Tasks Completed

### 1. Sample Editor Controls (Wire-up)
- Added sample editor parameters to `spc_params.h`:
  - `kParamSampleSelect` (600) - Sample index 0-127
  - `kParamSamplePitch` (601) - Pitch offset -24 to +24 semitones
  - `kParamSampleVolume` (602) - Volume 0-100%
  - `kParamSampleAttack` (603) - ADSR Attack 0-15
  - `kParamSampleDecay` (604) - ADSR Decay 0-7
  - `kParamSampleSustain` (605) - ADSR Sustain 0-7
  - `kParamSampleRelease` (606) - ADSR Release 0-31
  - `kParamSampleTrigger` (607) - Momentary trigger
  - `kParamViewMode` (700) - View tab selector (Mixer/Samples/Browser)
- Added parameter registration in `spc_controller.cpp`
- Added parameter handling in `spc_processor.cpp` with `updateSampleEnvelope()` helper
- ADSR packs into SPC format (ADSR1/ADSR2 bytes)

### 2. View Mode Tabs (ViewSwitcher)
- Created `view_switcher.h/cpp`:
  - `ViewSwitcher` - Container showing one panel at a time
  - `ViewSwitcherController` - Responds to parameter changes
  - `ViewSwitcherFactory` - VSTGUI factory for UI XML

### 3. Keyboard Shortcuts (KeyboardHandler)
- Created `keyboard_handler.h/cpp`:
  - Implements `IKeyboardHook` interface
  - **Space** - Toggle play/pause
  - **L** - Toggle loop
  - **Escape** - Stop and reset position
  - **Up/Down** - Adjust master volume ±5%
  - **1-8** - Toggle individual voice mute
  - **M** - Mute all voices
  - **N** - Unmute all voices / disable solos
  - **Home** - Jump to start

### 4. Preset Browser Integration
- Updated `spc_editor.cpp` to find and initialize PresetBrowser
- Added load callback connecting to controller's `loadSpcFile()`
- Added default SPC search paths (Windows/macOS)
- Automatic scanning and sorting on startup

### 5. MIDI Learn Functionality
- Created `midi_learn.h/cpp`:
  - `MidiMapping` struct for CC-to-parameter mappings
  - `MidiLearnHandler` class with learn mode
  - `MidiLearnOverlay` for visual feedback
  - Serialization/deserialization for persistence
- Integrated into `SpcController`:
  - `startMidiLearn()` / `cancelMidiLearn()`
  - `processMidiCC()` for incoming CC handling
  - `getMidiLearnHandler()` accessor

### 6. Real-Time Waveform Pipeline
- Added waveform capture in `spc_processor.cpp` process()
- Added message types in `spc_messages.h`:
  - `kMsgRequestWaveform` - Controller requests data
  - `kMsgWaveformData` - Processor sends samples
- Controller receives and caches waveform data with mutex protection
- Editor's `onTimer()` now requests real data, falls back to test data

## Files Modified

### vst3/src/
- `spc_params.h` - Added sample editor and view mode parameters
- `spc_messages.h` - Added waveform message types
- `spc_controller.h` - Added MidiLearnHandler, waveform accessors
- `spc_controller.cpp` - Added MIDI learn, waveform handling
- `spc_processor.h` - Added waveform capture buffers, atomic sample count
- `spc_processor.cpp` - Added waveform capture, request handling

### vst3/src/gui/
- `view_switcher.h` (NEW) - ViewSwitcher class
- `view_switcher.cpp` (NEW) - Panel visibility management
- `keyboard_handler.h` (NEW) - KeyboardHandler class
- `keyboard_handler.cpp` (NEW) - Shortcut implementations
- `midi_learn.h` (NEW) - MIDI learn classes
- `midi_learn.cpp` (NEW) - MIDI mapping implementation
- `spc_editor.h` - Added member pointers, timer, keyboard handler
- `spc_editor.cpp` - Integrated all components, real waveform data

### vst3/
- `CMakeLists.txt` - Added new source files

### ~manual-testing/
- `VST3_TESTING_GUIDE.md` - Added test cases TC-016 through TC-022

## New Test Cases Added

| Test | Description |
|------|-------------|
| TC-016 | Keyboard shortcuts |
| TC-017 | View mode switching |
| TC-018 | Sample editor controls |
| TC-019 | Real-time visualization updates |
| TC-020 | MIDI learn mode |
| TC-021 | MIDI learn persistence |
| TC-022 | Pitch bend per channel |

## Architecture Notes

### Waveform Data Flow
```
Processor (process thread)
    ↓ captures audio in waveformLeft_/waveformRight_
    ↓ receives kMsgRequestWaveform
    ↓ sends kMsgWaveformData with samples

Controller (main thread)
    ↓ receives kMsgWaveformData
    ↓ stores in waveformLeft_/waveformRight_ (mutex protected)
    
Editor (GUI thread, timer callback)
    ↓ calls controller_->requestWaveformData()
    ↓ calls controller_->getWaveformData()
    ↓ updates WaveformView / SpectrumView
```

### MIDI Learn Flow
```
Controller receives MIDI CC (from processor via message)
    ↓ processMidiCC(channel, cc, value)
    ↓ MidiLearnHandler checks learn mode
    ↓ If learning: create mapping, exit learn mode
    ↓ If mapped: apply value to parameter
```

## What's Next

1. **Build and Test** - Compile and verify all changes work together
2. **UI Layout XML** - Create/update `spc_editor.uidesc` with ViewSwitcher panels
3. **MIDI CC Processing** - Wire MIDI CC from processor to controller
4. **Sample List Population** - Get sample list from loaded SPC
5. **Save/Restore MIDI Mappings** - Persist with plugin state
6. **Commit and Push** - Version control checkpoint

## Notes

- Waveform buffer capped at 512 samples per message to avoid large transfers
- MIDI learn mappings stored as simple CSV format for easy debugging
- Keyboard handler registered/unregistered properly on editor open/close
- Timer runs at 60 FPS (16ms interval) for smooth visualizations
- Fallback test data generated when no real audio available
