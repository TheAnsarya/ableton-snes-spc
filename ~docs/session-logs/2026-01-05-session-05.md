# Session 05 - Reference Tools and Panel Switching

**Date:** 2026-01-05
**Focus:** GoodSPC reference infrastructure, SPC engine analyzer, MIDI CC wiring, UI panel switching

## Summary

Set up infrastructure for SPC reference files and testing, wired MIDI CC events for MIDI learn functionality, and implemented panel switching in the editor UI.

## Completed Tasks

### 1. Reference Files Infrastructure (`~references/`)

Created a comprehensive system for managing large reference files that shouldn't be committed to git:

- [download-references.ps1](~references/download-references.ps1) - Downloads GoodSPC v3.22 from archive.org
  - Supports resumable downloads
  - 7-Zip extraction support
  - Progress reporting

- [analyze-spc-engines.ps1](~references/analyze-spc-engines.ps1) - SPC audio driver detection
  - Pattern-based driver identification (N-SPC, AKAO, KANKICHI, HAL, Capcom, Rare, etc.)
  - Heuristic analysis for unknown drivers
  - Generates JSON report with driver distribution
  - Can sample SPCs from GoodSPC collection for testing

- [README.md](~references/README.md) - Documentation for reference files

### 2. MIDI CC Forwarding for MIDI Learn

Connected the MIDI event processing pipeline:

- Added new message type `kMsgMidiCC` with attributes:
  - `kAttrMidiChannel`
  - `kAttrMidiCCNumber`
  - `kAttrMidiCCValue`

- Processor now forwards CC events to controller via `forwardMidiCCToController()`
- Controller receives and routes to `processMidiCC()` for MIDI learn handler

**Files modified:**
- [spc_messages.h](vst3/src/spc_messages.h) - Added message IDs and attributes
- [spc_processor.h](vst3/src/spc_processor.h) - Added forward function declaration
- [spc_processor.cpp](vst3/src/spc_processor.cpp) - Implemented forwarding
- [spc_controller.cpp](vst3/src/spc_controller.cpp) - Handle incoming CC messages

### 3. UI Panel Switching

Restructured the editor UI to support three switchable view panels:

**Panel 0 - Mixer:**
- 8-channel volume sliders
- Mute/Solo buttons per channel
- Pitch bend controls (per-channel + global range)
- Voice meters placeholder

**Panel 1 - Samples:**
- Sample selector dropdown
- Large waveform preview
- ADSR envelope controls (Attack, Decay, Sustain, Release)
- Sample parameters (Pitch, Volume)
- BRR sample directory view
- Voice assignment buttons

**Panel 2 - Browser:**
- Search bar
- Folder tree view
- File list view
- File info/metadata display
- Recent files list
- Load/Preview/Favorites buttons

**Implementation:**
- Added `custom-view-name` attributes to identify panels
- `findPanelViews()` locates panels by name
- `updatePanelVisibility()` shows/hides based on ViewMode parameter
- Panels occupy the same area, only one visible at a time

**Files modified:**
- [spc_editor.uidesc](vst3/resource/spc_editor.uidesc) - Complete UI restructure
- [spc_editor.h](vst3/src/gui/spc_editor.h) - Added panel pointers and methods
- [spc_editor.cpp](vst3/src/gui/spc_editor.cpp) - Added panel discovery and switching

## Driver Signatures in Analyzer

The analyzer recognizes these SPC audio drivers:

| Driver | Typical Games | Pattern Location |
|--------|---------------|------------------|
| N-SPC | Nintendo first-party | $0000, $0500 |
| AKAO | Square (FF, CT) | $0200, $1000 |
| KANKICHI | Konami | $0100 |
| HAL | Kirby, Earthbound | $0400 |
| Capcom | Mega Man X, SF2 | $0000 |
| Rare | DKC series | $0200 |
| Enix | ActRaiser, Soul Blazer | $0100 |
| Quintet | Terranigma | $0300 |

## Git Commits

```
ef3a129 feat: Add MIDI CC forwarding, panel switching, and reference tools
```

## Architecture Notes

### MIDI Event Flow
```
DAW MIDI Input
    ↓
SpcProcessor::processMidiEvents()
    ├→ dotnetHost_->midiControlChange() (for audio engine)
    └→ forwardMidiCCToController() (for MIDI learn)
           ↓
       IMessage with kMsgMidiCC
           ↓
SpcController::notify()
    ↓
processMidiCC()
    ↓
MidiLearnHandler (if learning)
```

### Panel Switching Flow
```
CSegmentButton (ViewMode tag=700)
    ↓
Parameter change notification
    ↓
updatePanelVisibility()
    ↓
setVisible() on each panel based on mode
```

## What's Next

1. **Build Testing**
   - Set up VST3 SDK environment
   - Fix any compilation errors
   - Test in DAW

2. **Custom View Classes**
   - Implement WaveformView custom drawing
   - Implement SpectrumView with FFT
   - Implement voice activity meters

3. **File Browser Implementation**
   - Add actual folder scanning
   - Implement file list population
   - SPC metadata reading for preview

4. **SPC Engine Testing**
   - Download GoodSPC archive
   - Run engine analyzer
   - Select diverse test files covering all driver types

5. **ADSR Visualization**
   - Draw actual envelope curve
   - Update in real-time as sliders change

6. **Sample Directory View**
   - Parse BRR sample directory from loaded SPC
   - Display sample list
   - Waveform preview for selected sample
